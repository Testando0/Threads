<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads Video Downloader | Future Tech</title>
    
    <!-- Google Fonts: Orbitron (Futurista) e Inter (Leitura) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configurações de Design Futurista -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        orbitron: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        cyber: {
                            dark: '#050b14',
                            panel: '#0f172a',
                            cyan: '#00f3ff',
                            purple: '#bc13fe',
                            accent: '#2dd4bf'
                        }
                    },
                    boxShadow: {
                        'neon-cyan': '0 0 10px rgba(0, 243, 255, 0.5), 0 0 20px rgba(0, 243, 255, 0.3)',
                        'neon-purple': '0 0 10px rgba(188, 19, 254, 0.5), 0 0 20px rgba(188, 19, 254, 0.3)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020408;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(188, 19, 254, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.1) 0%, transparent 40%);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        /* Efeito de Vidro */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Input Customizado */
        .cyber-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 243, 255, 0.2);
            transition: all 0.3s ease;
        }
        .cyber-input:focus {
            border-color: #00f3ff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            outline: none;
        }

        /* Botão Futurista */
        .cyber-btn {
            background: linear-gradient(90deg, #00f3ff, #2dd4bf);
            color: #000;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .cyber-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, #bc13fe, #00f3ff);
            z-index: -1;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        .cyber-btn:hover::before {
            opacity: 1;
        }
        
        /* Grid de Fundo Animado */
        .grid-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            z-index: -1;
            pointer-events: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #050b14; 
        }
        ::-webkit-scrollbar-thumb {
            background: #1e293b; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00f3ff; 
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Grid Background -->
    <div class="grid-bg"></div>

    <!-- Main Container -->
    <main class="w-full max-w-2xl glass-panel rounded-2xl p-6 md:p-10 shadow-2xl relative border-t border-cyber-cyan/20 animate-float">
        
        <!-- Glow Effect Corner -->
        <div class="absolute -top-10 -right-10 w-40 h-40 bg-cyber-cyan/20 rounded-full blur-3xl pointer-events-none"></div>
        <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-cyber-purple/20 rounded-full blur-3xl pointer-events-none"></div>

        <!-- Header -->
        <div class="text-center mb-8 relative z-10">
            <div class="inline-block mb-3 p-3 rounded-full border border-cyber-cyan/30 bg-cyber-cyan/5 shadow-neon-cyan">
                <i class="fa-solid fa-at text-3xl text-cyber-cyan"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-orbitron font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyber-cyan to-cyber-purple tracking-wider mb-2">
                THREADS DOWNLOADER
            </h1>
            <p class="text-gray-400 text-sm font-light tracking-widest uppercase">
                Sistema de Extração de Mídia de Alta Performance
            </p>
        </div>

        <!-- Input Area -->
        <div class="relative z-10 mb-8">
            <div class="flex flex-col gap-4">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-link text-gray-500 group-focus-within:text-cyber-cyan transition-colors"></i>
                    </div>
                    <!-- Placeholder e ID atualizados -->
                    <input type="text" id="urlInput" 
                        class="w-full cyber-input text-white rounded-lg py-4 pl-12 pr-4 font-mono text-sm md:text-base placeholder-gray-600 focus:placeholder-gray-500"
                        placeholder="Cole o link do Threads aqui (ex: https://www.threads.com/...)"
                        autocomplete="off">
                </div>

                <button onclick="fetchVideo()" id="searchBtn" 
                    class="cyber-btn w-full font-orbitron font-bold uppercase tracking-wider py-4 rounded-lg shadow-neon-cyan hover:shadow-neon-purple transition-all transform hover:scale-[1.01] flex justify-center items-center gap-2">
                    <span>Processar Dados</span>
                    <i class="fa-solid fa-bolt"></i>
                </button>
            </div>
            
            <!-- Error Message -->
            <div id="errorMsg" class="hidden mt-4 p-3 rounded bg-red-500/10 border border-red-500/30 text-red-400 text-sm text-center font-mono">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i> <span id="errorText">Erro ao buscar vídeo.</span>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="hidden py-8 flex-col items-center justify-center relative z-10">
            <div class="w-16 h-16 border-4 border-cyber-panel border-t-cyber-cyan rounded-full animate-spin shadow-neon-cyan mb-4"></div>
            <p id="loaderText" class="text-cyber-cyan font-orbitron text-sm animate-pulse">Descriptografando API...</p>
        </div>

        <!-- Result Area -->
        <div id="resultArea" class="hidden relative z-10 bg-black/40 rounded-xl overflow-hidden border border-gray-700/50 transition-all duration-500 opacity-0 transform translate-y-4">
            
            <!-- Video Player -->
            <div class="relative group">
                <video id="videoPlayer" controls class="w-full aspect-video bg-black rounded-t-xl" playsinline preload="metadata">
                    Seu navegador não suporta a tag de vídeo.
                </video>
                <div class="absolute top-2 right-2 px-2 py-1 bg-black/70 backdrop-blur rounded text-xs font-mono text-cyber-cyan border border-cyber-cyan/20">
                    MP4 • HD
                </div>
            </div>

            <!-- Meta & Actions -->
            <div class="p-5 flex flex-col md:flex-row justify-between items-center gap-4 border-t border-gray-800">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center border border-gray-600">
                        <i class="fa-solid fa-video text-cyber-purple"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-sm">Mídia Encontrada</h3>
                        <p class="text-gray-500 text-xs">Pronto para download</p>
                    </div>
                </div>

                <div class="flex w-full md:w-auto gap-2">
                    <button onclick="copyLink()" class="flex-1 md:flex-none px-4 py-2 rounded bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm border border-gray-700 transition-colors" title="Copiar Link">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                    
                    <button id="downloadBtn" class="flex-1 md:flex-none px-6 py-2 rounded bg-cyber-cyan/10 hover:bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan/50 font-orbitron text-sm uppercase tracking-wider shadow-[0_0_10px_rgba(0,243,255,0.1)] hover:shadow-[0_0_15px_rgba(0,243,255,0.3)] transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> Baixar
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center border-t border-gray-800 pt-4">
            <p class="text-gray-600 text-xs font-mono">
                POWERED BY <span class="text-cyber-purple">KUROMI SYSTEM</span> &bull; API v1.0
            </p>
        </div>

    </main>

    <!-- Toast Notification (Hidden by default) -->
    <div id="toast" class="fixed bottom-5 right-5 bg-cyber-panel border-l-4 border-cyber-cyan text-white px-6 py-3 rounded shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-cyber-cyan"></i>
        <span id="toastMsg">Sucesso!</span>
    </div>

    <script>
        const API_URL = "https://kuromi-system-tech.onrender.com/api/threads?url=";
        const CORS_PROXY = "https://corsproxy.io/?";
        
        const urlInput = document.getElementById('urlInput');
        const searchBtn = document.getElementById('searchBtn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const resultArea = document.getElementById('resultArea');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');
        const videoPlayer = document.getElementById('videoPlayer');
        const downloadBtn = document.getElementById('downloadBtn');

        let currentVideoUrl = "";

        async function fetchVideo() {
            const url = urlInput.value.trim();

            // Reset UI
            hideError();
            resultArea.classList.add('hidden');
            resultArea.classList.remove('opacity-100', 'translate-y-0');
            resultArea.classList.add('opacity-0', 'translate-y-4');
            videoPlayer.pause();
            videoPlayer.src = "";
            loaderText.innerText = "Descriptografando API...";

            // Validation
            if (!url) {
                showError("Por favor, insira um link válido do Threads.");
                return;
            }
            
            // Validação relaxada para aceitar ambos caso usuário troque de novo
            if (!url.includes('threads.com') && !url.includes('threads.net')) {
                showError("O link deve ser do domínio threads.com ou threads.net.");
                return;
            }

            // Start Loading
            setLoading(true);

            try {
                // TENTATIVA 1: Acesso Direto
                console.log("Tentando acesso direto à API...");
                let response = await fetchWithTimeout(`${API_URL}${encodeURIComponent(url)}`, 8000);
                
                // Se falhar o acesso direto (geralmente CORS em browser), tenta via Proxy
                if (!response.ok) {
                    throw new Error("Erro na conexão direta");
                }
                
                let data = await response.json();
                processData(data);

            } catch (err) {
                console.warn("Acesso direto falhou, tentando via Proxy...", err);
                loaderText.innerText = "Tentando rota alternativa (Proxy)...";
                
                try {
                    // TENTATIVA 2: Via CORS Proxy
                    const proxyUrl = `${CORS_PROXY}${encodeURIComponent(API_URL + url)}`;
                    let responseProxy = await fetchWithTimeout(proxyUrl, 15000); // Mais tempo para o proxy
                    let dataProxy = await responseProxy.json();
                    processData(dataProxy);
                } catch (errProxy) {
                    console.error(errProxy);
                    showError("Falha na conexão. A API pode estar offline ou bloqueada. Tente novamente.");
                }
            } finally {
                setLoading(false);
            }
        }

        // Função auxiliar com Timeout para não ficar carregando infinitamente
        async function fetchWithTimeout(resource, timeout = 8000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, {
                signal: controller.signal
            });
            clearTimeout(id);
            return response;
        }

        function processData(data) {
            if (data.status && data.result && data.result.media && data.result.media.length > 0) {
                const videoData = data.result.media.find(m => m.type === 'video') || data.result.media[0];
                
                if (videoData) {
                    displayResult(videoData);
                } else {
                    showError("Nenhum vídeo encontrado neste post.");
                }
            } else {
                showError("Não foi possível processar o vídeo. Verifique se o perfil é público.");
            }
        }

        function displayResult(media) {
            currentVideoUrl = media.url;
            
            // Set Player Attributes
            videoPlayer.src = currentVideoUrl;
            if(media.thumb) videoPlayer.poster = media.thumb;
            
            // Configure Download Button Logic
            downloadBtn.onclick = () => handleDownload(currentVideoUrl);

            // Show UI with animation
            resultArea.classList.remove('hidden');
            // Small delay to allow 'hidden' removal to register before transition
            setTimeout(() => {
                resultArea.classList.remove('opacity-0', 'translate-y-4');
                resultArea.classList.add('opacity-100', 'translate-y-0');
            }, 50);
        }

        /**
         * Lógica de Download Sem Redirecionamento
         */
        async function handleDownload(url) {
            const btnOriginalContent = downloadBtn.innerHTML;
            downloadBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Baixando...`;
            downloadBtn.disabled = true;

            try {
                // Tenta fetch direto via Proxy para evitar CORS na mídia também, se necessário
                // Mas geralmente mídia (CDN) tem CORS aberto. Tenta direto primeiro.
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                // Gera um nome de arquivo com timestamp
                a.download = `threads_video_${new Date().getTime()}.mp4`; 
                
                document.body.appendChild(a);
                a.click();
                
                // Limpeza
                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
                showToast("Download iniciado com sucesso!");

            } catch (error) {
                console.warn("CORS ou erro de rede impediu download direto. Usando método alternativo.", error);
                
                // Fallback: Abre em nova aba para o navegador lidar
                window.open(url, '_blank');
                showToast("Download aberto em nova aba (Restrição de Navegador).");
            } finally {
                downloadBtn.innerHTML = btnOriginalContent;
                downloadBtn.disabled = false;
            }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                searchBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processando...`;
                searchBtn.disabled = true;
                searchBtn.classList.add('opacity-70', 'cursor-not-allowed');
                loader.classList.remove('hidden');
                loader.classList.add('flex');
            } else {
                searchBtn.innerHTML = `<span>Processar Dados</span> <i class="fa-solid fa-bolt"></i>`;
                searchBtn.disabled = false;
                searchBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function showError(msg) {
            errorText.innerText = msg;
            errorMsg.classList.remove('hidden');
        }

        function hideError() {
            errorMsg.classList.add('hidden');
        }

        function copyLink() {
            if(!currentVideoUrl) return;
            
            navigator.clipboard.writeText(currentVideoUrl).then(() => {
                showToast("Link copiado para a área de transferência!");
            }).catch(() => {
                showToast("Erro ao copiar link.");
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            
            toastMsg.innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Permite usar Enter no input
        urlInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                searchBtn.click();
            }
        });
    </script>
</body>
</html>


